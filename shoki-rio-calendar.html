<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>カレンダー</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500&display=swap" rel="stylesheet">
<style>
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

:root {
  --c-shoki: #4a90d9;
  --c-rio:   #d97b6c;
  --c-shared:#7fba6a;
  --bg:      #f5f5f3;
  --surface: #ffffff;
  --border:  #ebebea;
  --text:    #1a1a1a;
  --muted:   #999;
  --sun:     #e05a5a;
  --sat:     #5a7de0;
}

html, body {
  height: 100%;
  overflow: hidden;
}

body {
  font-family: 'Noto Sans JP', sans-serif;
  background: var(--bg);
  color: var(--text);
  font-weight: 300;
  font-size: 14px;
  display: flex;
  flex-direction: column;
}

/* ══════════════════════════════
   HEADER
══════════════════════════════ */
.header {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  z-index: 30;
}

.header-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 16px 10px;
}

.month-nav {
  display: flex;
  align-items: center;
  gap: 4px;
}
.nav-arrow {
  background: none; border: none;
  width: 36px; height: 36px;
  display: flex; align-items: center; justify-content: center;
  font-size: 20px; color: var(--muted); cursor: pointer;
  border-radius: 8px;
  transition: background .1s;
}
.nav-arrow:active { background: var(--bg); }

.month-btn {
  background: none; border: none;
  font-family: 'Noto Sans JP'; font-size: 18px; font-weight: 500;
  color: var(--text); cursor: pointer;
  padding: 4px 8px; border-radius: 8px;
  display: flex; align-items: center; gap: 4px;
  transition: background .1s;
}
.month-btn:active { background: var(--bg); }
.month-btn .caret { font-size: 10px; color: var(--muted); }

.header-actions {
  display: flex; align-items: center; gap: 8px;
}
.today-btn {
  background: none; border: 1px solid var(--border);
  padding: 6px 12px; border-radius: 20px;
  font-family: 'Noto Sans JP'; font-size: 13px; color: var(--muted);
  cursor: pointer; transition: all .1s;
}
.today-btn:active { background: var(--bg); }

.add-fab {
  background: var(--text); color: #fff;
  border: none; width: 36px; height: 36px;
  border-radius: 50%; font-size: 22px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; flex-shrink: 0;
  box-shadow: 0 2px 8px rgba(0,0,0,.2);
  transition: transform .1s;
}
.add-fab:active { transform: scale(.93); }

/* Legend row */
.legend-row {
  display: flex;
  gap: 6px;
  padding: 0 16px 10px;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
.legend-row::-webkit-scrollbar { display: none; }
.legend-item {
  display: flex; align-items: center; gap: 5px;
  font-size: 12px; color: #555;
  padding: 4px 10px; border-radius: 20px;
  border: 1.5px solid transparent;
  cursor: pointer; user-select: none;
  white-space: nowrap; transition: opacity .15s;
  flex-shrink: 0;
}
.legend-item.active { border-color: currentColor; }
.legend-item.dimmed { opacity: .3; }
.legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

/* Weekday header */
.weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  padding: 0 4px;
}
.wday {
  text-align: center;
  font-size: 11px; color: var(--muted);
  padding: 4px 0; font-weight: 400;
}
.wday.sun { color: var(--sun); }
.wday.sat { color: var(--sat); }

/* ══════════════════════════════
   CALENDAR BODY (fixed, no scroll)
══════════════════════════════ */
.cal-scroll {
  flex-shrink: 0;
  overflow: hidden;
  padding: 4px 4px 4px;
}

/* Swipe wrapper: 3 months side by side */
.cal-swipe {
  display: flex;
  width: 300%;
  transition: transform .3s ease;
}
.cal-page {
  width: calc(100% / 3);
  flex-shrink: 0;
}

.week-row {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
  margin-bottom: 2px;
  position: relative;
}

.cell {
  background: var(--surface);
  min-height: 76px;
  padding: 4px 2px 2px 3px;
  border-radius: 6px;
  cursor: pointer;
  position: relative;
  border: 1px solid transparent;
  transition: background .1s;
}
.cell:active { background: #f0f0f0; }
.cell.other { background: #fafaf8; }
.cell.other .dnum { color: #d0d0d0; }
.cell.today .dnum {
  background: var(--text); color: #fff !important;
  border-radius: 50%;
  width: 20px; height: 20px;
  display: flex; align-items: center; justify-content: center;
}
.dnum {
  font-size: 11px; font-weight: 400;
  width: 20px; height: 20px;
  display: flex; align-items: center; justify-content: center;
  margin-bottom: 1px;
}
.cell.sunday .dnum { color: var(--sun); }
.cell.saturday .dnum { color: var(--sat); }

/* ── Event bars ── */
.ev-bars-layer {
  position: absolute;
  left: 0; right: 0;
  top: 25px;
  pointer-events: none;
}
.ev-bar {
  position: absolute;
  height: 16px; line-height: 16px;
  font-size: 10px; color: #fff; font-weight: 400;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  padding: 0 4px;
  cursor: pointer; pointer-events: all;
  border-radius: 0;
}
.ev-bar:active { opacity: .8; }
.ev-bar.bar-start { border-radius: 3px 0 0 3px; }
.ev-bar.bar-end   { border-radius: 0 3px 3px 0; }
.ev-bar.bar-solo  { border-radius: 3px; }

.more-label {
  position: absolute;
  font-size: 9px; color: var(--muted);
}

/* ══════════════════════════════
   UPCOMING PANEL (scrollable)
══════════════════════════════ */
.upcoming {
  flex: 1;
  background: var(--surface);
  border-top: 1px solid var(--border);
  padding: 10px 16px 16px;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}
.upcoming-title {
  font-size: 11px; color: var(--muted);
  text-transform: uppercase; letter-spacing: .07em;
  margin-bottom: 10px; font-weight: 400;
}
.up-item {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 0;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
}
.up-item:last-child { border-bottom: none; }
.up-dot {
  width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
}
.up-info { flex: 1; min-width: 0; }
.up-title {
  font-size: 14px; font-weight: 400;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.up-title.priority { font-weight: 500; }
.up-meta { font-size: 11px; color: var(--muted); margin-top: 2px; }
.up-star {
  font-size: 18px; color: #ddd; flex-shrink: 0;
  cursor: pointer; padding: 2px 4px;
  transition: color .15s;
  -webkit-tap-highlight-color: transparent;
}
.up-star.on { color: #f5a623; }
.up-empty {
  font-size: 13px; color: var(--muted); padding: 8px 0;
}

/* ══════════════════════════════
   JUMP SHEET (bottom sheet)
══════════════════════════════ */
.sheet-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,.3); z-index: 100;
}
.sheet-overlay.open { display: block; }

.jump-sheet {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--surface);
  border-radius: 20px 20px 0 0;
  padding: 0 20px 40px;
  z-index: 101;
  transform: translateY(100%);
  transition: transform .25s ease;
  box-shadow: 0 -4px 24px rgba(0,0,0,.12);
}
.jump-sheet.open { transform: translateY(0); }

.sheet-handle {
  width: 40px; height: 4px; background: #ddd;
  border-radius: 2px; margin: 12px auto 20px;
}
.jump-year-row {
  display: flex; align-items: center; justify-content: center;
  gap: 24px; margin-bottom: 20px;
}
.jump-yr-btn {
  background: none; border: 1px solid var(--border);
  width: 40px; height: 40px; border-radius: 50%;
  font-size: 18px; color: var(--muted);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
}
.jump-yr-btn:active { background: var(--bg); }
.jump-year-txt { font-size: 22px; font-weight: 500; min-width: 90px; text-align: center; }
.jump-months {
  display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
}
.jump-mo {
  padding: 12px 4px; text-align: center;
  font-size: 14px; color: #444;
  border-radius: 10px; cursor: pointer;
  transition: background .1s;
}
.jump-mo:active { background: var(--bg); }
.jump-mo.current { background: var(--text); color: #fff; }

/* ══════════════════════════════
   EVENT MODAL (bottom sheet)
══════════════════════════════ */
.modal-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,.3); z-index: 200;
}
.modal-overlay.open { display: block; }

.modal-sheet {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--surface);
  border-radius: 20px 20px 0 0;
  z-index: 201;
  transform: translateY(100%);
  transition: transform .25s ease;
  box-shadow: 0 -4px 24px rgba(0,0,0,.12);
  max-height: 92vh;
  display: flex; flex-direction: column;
}
.modal-sheet.open { transform: translateY(0); }

.modal-handle-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 20px 0;
  flex-shrink: 0;
}
.modal-handle { width: 40px; height: 4px; background: #ddd; border-radius: 2px; margin: 0 auto; }
.modal-x {
  background: #f0f0f0; border: none;
  width: 30px; height: 30px; border-radius: 50%;
  font-size: 16px; color: #666; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}

.modal-head-inner {
  padding: 14px 20px 12px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.modal-head-inner h2 { font-size: 17px; font-weight: 500; }

.modal-body {
  padding: 16px 20px 20px;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  flex: 1;
}

/* Form */
.fg { margin-bottom: 16px; }
.fg > label {
  display: block; font-size: 11px; color: var(--muted);
  text-transform: uppercase; letter-spacing: .07em;
  margin-bottom: 7px; font-weight: 400;
}
.fg input, .fg textarea {
  width: 100%; border: 1px solid var(--border);
  border-radius: 10px; padding: 12px 14px;
  font-family: 'Noto Sans JP'; font-size: 15px;
  color: var(--text); background: var(--bg);
  outline: none; font-weight: 300;
  -webkit-appearance: none;
  transition: border-color .15s;
}
.fg input:focus, .fg textarea:focus { border-color: #aaa; background: #fff; }
.fg textarea { height: 72px; resize: none; }

.row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
.row2 .fg { margin-bottom: 0; }

/* Owner tabs */
.owner-tabs { display: flex; background: var(--bg); border-radius: 10px; padding: 3px; gap: 2px; }
.owner-tab {
  flex: 1; padding: 9px 4px; text-align: center;
  font-size: 13px; font-family: 'Noto Sans JP';
  border-radius: 8px; cursor: pointer; color: var(--muted);
  transition: all .15s; border: none; background: none;
  font-weight: 400;
}
.owner-tab.sel-shoki  { background: #fff; color: #2a6cb0; font-weight: 500; box-shadow: 0 1px 4px rgba(0,0,0,.1); }
.owner-tab.sel-rio    { background: #fff; color: #b05040; font-weight: 500; box-shadow: 0 1px 4px rgba(0,0,0,.1); }
.owner-tab.sel-shared { background: #fff; color: #4a8c36; font-weight: 500; box-shadow: 0 1px 4px rgba(0,0,0,.1); }

/* Color indicator strip under owner tabs */
.owner-strip {
  height: 3px; border-radius: 2px; margin-top: 6px;
  transition: background .2s;
}

.check-row {
  display: flex; align-items: center; gap: 10px;
  padding: 12px 14px; border-radius: 10px;
  border: 1.5px solid var(--border);
  background: var(--bg);
  cursor: pointer;
  transition: all .2s;
}
.check-row input[type=checkbox] { display: none; }
.check-row .cb-box {
  width: 20px; height: 20px; border-radius: 5px;
  border: 1.5px solid #ccc; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; color: #fff;
  transition: all .2s;
}
.check-row span { font-size: 14px; color: #444; transition: color .2s; }

/* remind = blue */
.check-row.remind-row.checked {
  border-color: #4a90d9; background: #eef4fc;
}
.check-row.remind-row.checked .cb-box {
  background: #4a90d9; border-color: #4a90d9;
}
.check-row.remind-row.checked span { color: #2a6cb0; font-weight: 500; }

/* priority = orange */
.check-row.priority-row.checked {
  border-color: #f5a623; background: #fff8ec;
}
.check-row.priority-row.checked .cb-box {
  background: #f5a623; border-color: #f5a623;
}
.check-row.priority-row.checked span { color: #b87010; font-weight: 500; }

/* Action buttons */
.modal-actions {
  display: flex; gap: 10px;
  padding: 12px 20px 16px;
  border-top: 1px solid var(--border);
  flex-shrink: 0;
  background: var(--surface);
}
.btn-del {
  background: none; border: 1px solid #f0a0a0;
  color: #e05a5a; border-radius: 10px; padding: 13px 18px;
  font-family: 'Noto Sans JP'; font-size: 14px;
  cursor: pointer; display: none; transition: background .1s;
}
.btn-del:active { background: #fff0f0; }
.btn-save {
  flex: 1; background: var(--text); color: #fff; border: none;
  border-radius: 10px; padding: 14px;
  font-family: 'Noto Sans JP'; font-size: 15px; font-weight: 500;
  cursor: pointer; transition: opacity .1s;
}
.btn-save:active { opacity: .85; }

/* Toast */
.toast {
  position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
  background: rgba(26,26,26,.9); color: #fff;
  padding: 10px 20px; border-radius: 20px;
  font-size: 13px; z-index: 400;
  white-space: nowrap;
  animation: toastIn .2s ease;
}
@keyframes toastIn { from { opacity:0; transform:translateX(-50%) translateY(8px); } }
</style>
</head>
<body>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBPKqkRJNNFzqH7DJX7Tifm1o05elHJbUI",
  authDomain: "shoki-rio-calendar.firebaseapp.com",
  projectId: "shoki-rio-calendar",
  storageBucket: "shoki-rio-calendar.firebasestorage.app",
  messagingSenderId: "184478672991",
  appId: "1:184478672991:web:9839db5b24c122ffd493ea",
  measurementId: "G-YGCLY113DQ"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const COL = collection(db, 'events');

// リアルタイム同期：Firestoreの変更を即座に反映
onSnapshot(COL, snap => {
  events = snap.docs.map(d => d.data());
  render();
  renderUpcoming();
  checkTodayReminders();
});

// グローバルに公開
window._fbSave = async (ev) => {
  await setDoc(doc(db, 'events', ev.id), ev);
};
window._fbDelete = async (id) => {
  await deleteDoc(doc(db, 'events', id));
};
</script>

<!-- ═══ HEADER ═══ -->
<div class="header">
  <div class="header-top">
    <div class="month-nav">
      <button class="nav-arrow" id="prevBtn">&#8249;</button>
      <button class="month-btn" id="monthBtn">
        <span id="monthLabelText"></span>
        <span class="caret">&#9660;</span>
      </button>
      <button class="nav-arrow" id="nextBtn">&#8250;</button>
    </div>
    <div class="header-actions">
      <button class="today-btn" id="todayBtn">今日</button>
      <button class="add-fab" id="openAddBtn">+</button>
    </div>
  </div>

  <div class="legend-row">
    <div class="legend-item active" data-owner="shoki" style="color:#2a6cb0;">
      <div class="legend-dot" style="background:var(--c-shoki);"></div>しょうき
    </div>
    <div class="legend-item active" data-owner="rio" style="color:#b05040;">
      <div class="legend-dot" style="background:var(--c-rio);"></div>りお
    </div>
    <div class="legend-item active" data-owner="shared" style="color:#4a8c36;">
      <div class="legend-dot" style="background:var(--c-shared);"></div>しょうき&りお
    </div>
  </div>

  <div class="weekdays">
    <div class="wday sun">日</div>
    <div class="wday">月</div>
    <div class="wday">火</div>
    <div class="wday">水</div>
    <div class="wday">木</div>
    <div class="wday">金</div>
    <div class="wday sat">土</div>
  </div>
</div>

<!-- ═══ CALENDAR ═══ -->
<div class="cal-scroll" id="calScroll">
  <div class="cal-swipe" id="calSwipe">
    <div class="cal-page" id="calPrev"></div>
    <div class="cal-page" id="calBody"></div>
    <div class="cal-page" id="calNext"></div>
  </div>
</div>

<!-- ═══ UPCOMING PANEL ═══ -->
<div class="upcoming" id="upcomingPanel">
  <div class="upcoming-title">直近の予定</div>
  <div id="upcomingList"></div>
</div>

<!-- ═══ JUMP SHEET ═══ -->
<div class="sheet-overlay" id="sheetOverlay"></div>
<div class="jump-sheet" id="jumpSheet">
  <div class="sheet-handle"></div>
  <div class="jump-year-row">
    <button class="jump-yr-btn" id="jumpPrevYr">&#8249;</button>
    <div class="jump-year-txt" id="jumpYearTxt"></div>
    <button class="jump-yr-btn" id="jumpNextYr">&#8250;</button>
  </div>
  <div class="jump-months" id="jumpMonths"></div>
</div>

<!-- ═══ EVENT MODAL SHEET ═══ -->
<div class="modal-overlay" id="modalOverlay"></div>
<div class="modal-sheet" id="modalSheet">
  <div class="modal-handle-row">
    <div style="width:30px;"></div>
    <div class="modal-handle"></div>
    <button class="modal-x" id="closeBtn">&#215;</button>
  </div>
  <div class="modal-head-inner">
    <h2 id="modalTitle">予定を追加</h2>
  </div>

  <div class="modal-body">
    <div class="fg">
      <label>だれの予定？</label>
      <div class="owner-tabs">
        <button class="owner-tab sel-shoki" data-owner="shoki">しょうき</button>
        <button class="owner-tab" data-owner="rio">りお</button>
        <button class="owner-tab" data-owner="shared">ふたり</button>
      </div>
      <div class="owner-strip" id="ownerStrip"></div>
    </div>

    <div class="fg">
      <label>タイトル</label>
      <input type="text" id="fTitle" placeholder="例：映画">
    </div>

    <div class="row2">
      <div class="fg">
        <label>開始日</label>
        <input type="date" id="fDateStart">
      </div>
      <div class="fg">
        <label>終了日</label>
        <input type="date" id="fDateEnd">
      </div>
    </div>

    <div class="row2">
      <div class="fg">
        <label>開始時間</label>
        <input type="time" id="fTimeStart">
      </div>
      <div class="fg">
        <label>終了時間</label>
        <input type="time" id="fTimeEnd">
      </div>
    </div>

    <div class="fg">
      <label>メモ</label>
      <textarea id="fMemo" placeholder="場所や持ち物など"></textarea>
    </div>

    <div class="fg">
      <div class="check-row remind-row" id="remindRow">
        <input type="checkbox" id="fRemind">
        <div class="cb-box" id="remindBox"></div>
        <span>開始日にリマインダーを表示</span>
      </div>
    </div>

    <div class="fg">
      <div class="check-row priority-row" id="priorityRow">
        <input type="checkbox" id="fPriority">
        <div class="cb-box" id="priorityBox"></div>
        <span>大事な予定（優先表示）</span>
      </div>
    </div>
  </div>

  <div class="modal-actions">
    <button class="btn-del" id="btnDel">削除</button>
    <button class="btn-save" id="btnSave">保存する</button>
  </div>
</div>

<script>
const OWNERS = {
  shoki:  { label:'しょうき',    color:'#4a90d9', selClass:'sel-shoki'  },
  rio:    { label:'りお',        color:'#d97b6c', selClass:'sel-rio'    },
  shared: { label:'ふたり',     color:'#7fba6a', selClass:'sel-shared' },
};

const BAR_H   = 17;
const BAR_GAP = 2;
const CELL_TOP = 22;

let events = [];
let yr = new Date().getFullYear(), mo = new Date().getMonth();
let editId = null, selOwner = 'shoki';
let hiddenOwners = new Set();
let jumpYr = yr;

function todayStr() {
  const d = new Date();
  return ds(d.getFullYear(), d.getMonth(), d.getDate());
}
function ds(y, m, d) {
  return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
}

/* ════════════════════════════════
   RENDER CALENDAR
════════════════════════════════ */
function renderMonth(targetYr, targetMo, containerId) {
  const first    = new Date(targetYr, targetMo, 1).getDay();
  const lastDay  = new Date(targetYr, targetMo+1, 0).getDate();
  const prevLast = new Date(targetYr, targetMo, 0).getDate();
  const today    = todayStr();

  const cells = [];
  for (let i=first-1; i>=0; i--) {
    const cm = targetMo===0?11:targetMo-1, cy = targetMo===0?targetYr-1:targetYr;
    cells.push({d:prevLast-i, cy, cm, other:true});
  }
  for (let d=1; d<=lastDay; d++) cells.push({d, cy:targetYr, cm:targetMo, other:false});
  while (cells.length%7) {
    const n=cells.length-lastDay-first+1;
    const cm=targetMo===11?0:targetMo+1, cy=targetMo===11?targetYr+1:targetYr;
    cells.push({d:n, cy, cm, other:true});
  }

  const weeks = [];
  for (let i=0; i<cells.length; i+=7) weeks.push(cells.slice(i,i+7));

  const visEvs = events.filter(e => !hiddenOwners.has(e.owner));
  const body = document.getElementById(containerId);
  body.innerHTML = '';

  weeks.forEach(week => {
    const weekStart = ds(week[0].cy, week[0].cm, week[0].d);
    const weekEnd   = ds(week[6].cy, week[6].cm, week[6].d);

    const weekEvs = visEvs.filter(ev => {
      const s = ev.dateStart||ev.date||'';
      const e = ev.dateEnd||s;
      return s<=weekEnd && e>=weekStart;
    });

    const lanes = [];
    const evLane = {};
    weekEvs.forEach(ev => {
      const evS = ev.dateStart||ev.date||'';
      const evE = ev.dateEnd||evS;
      const barS = evS<weekStart?weekStart:evS;
      const barE = evE>weekEnd  ?weekEnd  :evE;
      let lane = lanes.findIndex(last => last<barS);
      if (lane===-1) { lane=lanes.length; lanes.push(''); }
      lanes[lane] = barE;
      evLane[ev.id] = {lane, barS, barE};
    });

    const totalLanes = lanes.length;
    const extraPb = totalLanes>0 ? totalLanes*(BAR_H+BAR_GAP)+4 : 4;

    const row = document.createElement('div');
    row.className = 'week-row';

    week.forEach(c => {
      const dateKey = ds(c.cy, c.cm, c.d);
      const dow = new Date(c.cy, c.cm, c.d).getDay();
      const cell = document.createElement('div');
      let cls='cell';
      if (c.other)   cls+=' other';
      if (dow===0)   cls+=' sunday';
      if (dow===6)   cls+=' saturday';
      if (dateKey===today && !c.other) cls+=' today';
      cell.className = cls;
      cell.style.paddingBottom = extraPb+'px';

      const dn = document.createElement('div');
      dn.className = 'dnum';
      dn.textContent = c.d;
      cell.appendChild(dn);

      if (!c.other) cell.addEventListener('click', () => openAdd(dateKey));
      row.appendChild(cell);
    });

    const layer = document.createElement('div');
    layer.className = 'ev-bars-layer';

    weekEvs.forEach(ev => {
      const info = evLane[ev.id];
      if (!info) return;
      const evS = ev.dateStart||ev.date||'';
      const evE = ev.dateEnd||evS;

      let colS = week.findIndex(c=>ds(c.cy,c.cm,c.d)===info.barS);
      let colE = week.findIndex(c=>ds(c.cy,c.cm,c.d)===info.barE);
      if (colS===-1) colS=0;
      if (colE===-1) colE=6;
      const span = colE-colS+1;

      const bar = document.createElement('div');
      bar.className = 'ev-bar';
      const isRS = info.barS===evS;
      const isRE = info.barE===evE;
      if (isRS&&isRE) bar.classList.add('bar-solo');
      else if (isRS)  bar.classList.add('bar-start');
      else if (isRE)  bar.classList.add('bar-end');

      bar.style.left   = `calc(${colS} * ((100% - 12px)/7 + 2px))`;
      bar.style.width  = `calc(${span} * (100% - 12px)/7 + ${span-1} * 2px)`;
      bar.style.top    = CELL_TOP + info.lane*(BAR_H+BAR_GAP) + 'px';
      bar.style.height = BAR_H+'px';
      bar.style.background = OWNERS[ev.owner]?.color||'#888';

      if (colS === week.findIndex(c=>ds(c.cy,c.cm,c.d)===info.barS)) {
        const t = ev.timeStart ? ev.timeStart.slice(0,5)+' ' : '';
        bar.textContent = t+ev.title;
      }

      bar.addEventListener('click', e => { e.stopPropagation(); openEdit(ev.id); });
      layer.appendChild(bar);
    });

    row.appendChild(layer);
    body.appendChild(row);
  });
}

function moOffset(y, m, delta) {
  let nm = m + delta, ny = y;
  if (nm > 11) { nm -= 12; ny++; }
  if (nm < 0)  { nm += 12; ny--; }
  return {ny, nm};
}

function render() {
  const MONTHS = ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'];
  document.getElementById('monthLabelText').textContent = `${yr}年 ${MONTHS[mo]}`;

  // Center swipe (no animation)
  const swipe = document.getElementById('calSwipe');
  swipe.style.transition = 'none';
  swipe.style.transform = 'translateX(-33.333%)';

  const prev = moOffset(yr, mo, -1);
  const next = moOffset(yr, mo, +1);
  renderMonth(prev.ny, prev.nm, 'calPrev');
  renderMonth(yr, mo, 'calBody');
  renderMonth(next.ny, next.nm, 'calNext');

  renderUpcoming();
}

/* ════════════════════════════════
   SWIPE NAVIGATION
════════════════════════════════ */
(function() {
  const scroll = document.getElementById('calScroll');
  let startX=0, startY=0, moved=false;

  scroll.addEventListener('touchstart', e => {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    moved = false;
  }, {passive:true});

  scroll.addEventListener('touchend', e => {
    const dx = e.changedTouches[0].clientX - startX;
    const dy = e.changedTouches[0].clientY - startY;
    if (Math.abs(dx) < 40 || Math.abs(dx) < Math.abs(dy)) return;

    const swipe = document.getElementById('calSwipe');
    const dir = dx < 0 ? 1 : -1; // 1=next, -1=prev
    const target = dir === 1 ? 'translateX(-66.666%)' : 'translateX(0%)';

    swipe.style.transition = 'transform .3s ease';
    swipe.style.transform = target;

    setTimeout(() => {
      if (dir === 1) { mo++; if(mo>11){mo=0;yr++;} }
      else           { mo--; if(mo<0){mo=11;yr--;} }
      render();
    }, 310);
  }, {passive:true});
})();

/* ════════════════════════════════
   UPCOMING PANEL
════════════════════════════════ */
function renderUpcoming() {
  const today = todayStr();
  const list = document.getElementById('upcomingList');

  // 今日以降の予定、優先フラグ付きを上に、その後日付順
  const upcoming = events
    .filter(e => (e.dateEnd||e.dateStart||e.date||'') >= today)
    .sort((a, b) => {
      if (!!b.priority !== !!a.priority) return b.priority ? 1 : -1;
      const as = a.dateStart||a.date||'';
      const bs = b.dateStart||b.date||'';
      return as < bs ? -1 : as > bs ? 1 : 0;
    })
    .slice(0, 10);

  list.innerHTML = '';
  if (upcoming.length === 0) {
    list.innerHTML = '<div class="up-empty">予定はありません</div>';
    return;
  }

  const MONTHS = ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'];
  upcoming.forEach(ev => {
    const item = document.createElement('div');
    item.className = 'up-item';

    const dot = document.createElement('div');
    dot.className = 'up-dot';
    dot.style.background = OWNERS[ev.owner]?.color||'#888';

    const info = document.createElement('div');
    info.className = 'up-info';

    const title = document.createElement('div');
    title.className = 'up-title' + (ev.priority ? ' priority' : '');
    title.textContent = ev.title;

    const d = new Date(ev.dateStart||ev.date);
    let metaStr = `${d.getMonth()+1}月${d.getDate()}日`;
    if (ev.dateEnd && ev.dateEnd !== ev.dateStart) {
      const de = new Date(ev.dateEnd);
      metaStr += ` 〜 ${de.getMonth()+1}月${de.getDate()}日`;
    }
    if (ev.timeStart) metaStr += ' ' + ev.timeStart.slice(0,5);

    const meta = document.createElement('div');
    meta.className = 'up-meta';
    meta.textContent = metaStr + ' · ' + (OWNERS[ev.owner]?.label||ev.owner);

    info.appendChild(title);
    info.appendChild(meta);

    const star = document.createElement('div');
    star.className = 'up-star' + (ev.priority ? ' on' : '');
    star.textContent = '★';
    star.addEventListener('click', e => {
      e.stopPropagation();
      ev.priority = !ev.priority;
      window._fbSave(ev).catch(()=>{});
    });

    item.appendChild(dot);
    item.appendChild(info);
    item.appendChild(star);
    item.addEventListener('click', () => openEdit(ev.id));
    list.appendChild(item);
  });
}

/* ════════════════════════════════
   JUMP SHEET
════════════════════════════════ */
function openJump() {
  jumpYr = yr;
  renderJump();
  document.getElementById('sheetOverlay').classList.add('open');
  document.getElementById('jumpSheet').classList.add('open');
}
function renderJump() {
  document.getElementById('jumpYearTxt').textContent = jumpYr+'年';
  const MONTHS = ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'];
  const grid = document.getElementById('jumpMonths');
  grid.innerHTML = '';
  MONTHS.forEach((m,i) => {
    const btn = document.createElement('div');
    btn.className = 'jump-mo' + (jumpYr===yr&&i===mo?' current':'');
    btn.textContent = m;
    btn.addEventListener('click', () => { yr=jumpYr; mo=i; render(); closeJump(); });
    grid.appendChild(btn);
  });
}
function closeJump() {
  document.getElementById('sheetOverlay').classList.remove('open');
  document.getElementById('jumpSheet').classList.remove('open');
}

document.getElementById('monthBtn').addEventListener('click', openJump);
document.getElementById('jumpPrevYr').addEventListener('click', () => { jumpYr--; renderJump(); });
document.getElementById('jumpNextYr').addEventListener('click', () => { jumpYr++; renderJump(); });
document.getElementById('sheetOverlay').addEventListener('click', closeJump);

/* ════════════════════════════════
   LEGEND FILTER
════════════════════════════════ */
document.querySelectorAll('.legend-item').forEach(el => {
  el.addEventListener('click', () => {
    const owner = el.dataset.owner;
    if (hiddenOwners.has(owner)) {
      hiddenOwners.delete(owner); el.classList.remove('dimmed'); el.classList.add('active');
    } else {
      hiddenOwners.add(owner); el.classList.add('dimmed'); el.classList.remove('active');
    }
    render();
  });
});

/* ════════════════════════════════
   OWNER SELECTOR
════════════════════════════════ */
function setOwner(owner) {
  selOwner = owner;
  document.querySelectorAll('.owner-tab').forEach(el => {
    el.classList.remove('sel-shoki','sel-rio','sel-shared');
    if (el.dataset.owner===owner) el.classList.add(OWNERS[owner].selClass);
  });
  document.getElementById('ownerStrip').style.background = OWNERS[owner].color;
}
document.querySelectorAll('.owner-tab').forEach(el => {
  el.addEventListener('click', () => setOwner(el.dataset.owner));
});

/* ════════════════════════════════
   MODAL SHEET
════════════════════════════════ */
function openModalSheet() {
  document.getElementById('modalOverlay').classList.add('open');
  document.getElementById('modalSheet').classList.add('open');
}
function closeModal() {
  document.getElementById('modalOverlay').classList.remove('open');
  document.getElementById('modalSheet').classList.remove('open');
  editId = null;
}

function openAdd(date) {
  editId = null;
  document.getElementById('modalTitle').textContent = '予定を追加';
  document.getElementById('btnDel').style.display = 'none';
  document.getElementById('fTitle').value = '';
  document.getElementById('fDateStart').value = date||todayStr();
  document.getElementById('fDateEnd').value   = date||todayStr();
  document.getElementById('fTimeStart').value = '';
  document.getElementById('fTimeEnd').value   = '';
  document.getElementById('fMemo').value = '';
  document.getElementById('fRemind').checked = false;
  document.getElementById('fPriority').checked = false;
  resetCheckUI();
  setOwner('shoki');
  openModalSheet();
  setTimeout(() => document.getElementById('fTitle').focus(), 300);
}
function openEdit(id) {
  const ev = events.find(e=>e.id===id); if(!ev) return;
  editId = id;
  document.getElementById('modalTitle').textContent = '予定を編集';
  document.getElementById('btnDel').style.display = 'block';
  document.getElementById('fTitle').value = ev.title;
  document.getElementById('fDateStart').value = ev.dateStart||ev.date||'';
  document.getElementById('fDateEnd').value   = ev.dateEnd||ev.dateStart||ev.date||'';
  document.getElementById('fTimeStart').value = ev.timeStart||'';
  document.getElementById('fTimeEnd').value   = ev.timeEnd||'';
  document.getElementById('fMemo').value = ev.memo||'';
  document.getElementById('fRemind').checked = !!ev.remind;
  document.getElementById('fPriority').checked = !!ev.priority;
  setCheckUI(ev.remind, ev.priority);
  setOwner(ev.owner||'shoki');
  openModalSheet();
}

/* ════════════════════════════════
   SAVE / DELETE
════════════════════════════════ */
function saveEvent() {
  const title = document.getElementById('fTitle').value.trim();
  if (!title) { document.getElementById('fTitle').focus(); return; }
  const dateStart = document.getElementById('fDateStart').value;
  if (!dateStart) return;
  let dateEnd = document.getElementById('fDateEnd').value||dateStart;
  if (dateEnd<dateStart) dateEnd = dateStart;

  const ev = {
    id: editId||Date.now().toString(),
    title, dateStart, dateEnd,
    timeStart: document.getElementById('fTimeStart').value,
    timeEnd:   document.getElementById('fTimeEnd').value,
    owner: selOwner,
    memo: document.getElementById('fMemo').value.trim(),
    remind: document.getElementById('fRemind').checked,
    priority: document.getElementById('fPriority').checked,
  };
  closeModal();
  toast(editId?'更新しました':'追加しました');
  window._fbSave(ev).catch(()=>toast('保存に失敗しました'));
}
function deleteEvent() {
  if (!editId||!confirm('この予定を削除しますか？')) return;
  const id = editId;
  closeModal();
  toast('削除しました');
  window._fbDelete(id).catch(()=>toast('削除に失敗しました'));
}

/* ════════════════════════════════
   TOAST / REMINDER
════════════════════════════════ */
function toast(msg) {
  document.querySelector('.toast')?.remove();
  const t = document.createElement('div');
  t.className='toast'; t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(), 2500);
}
function checkTodayReminders() {
  const today = todayStr();
  events.filter(e=>(e.dateStart||e.date)===today&&e.remind)
    .forEach((ev,i)=>setTimeout(()=>toast(`リマインダー: ${ev.title}`), 800+i*1200));
}

/* ════════════════════════════════
   WIRE UP
════════════════════════════════ */
document.getElementById('prevBtn').addEventListener('click', () => { mo--; if(mo<0){mo=11;yr--;} render(); });
document.getElementById('nextBtn').addEventListener('click', () => { mo++; if(mo>11){mo=0;yr++;} render(); });
document.getElementById('todayBtn').addEventListener('click', () => { const n=new Date(); yr=n.getFullYear(); mo=n.getMonth(); render(); });
document.getElementById('openAddBtn').addEventListener('click', () => openAdd(todayStr()));
document.getElementById('closeBtn').addEventListener('click', closeModal);
document.getElementById('modalOverlay').addEventListener('click', closeModal);
document.getElementById('btnSave').addEventListener('click', saveEvent);
document.getElementById('btnDel').addEventListener('click', deleteEvent);

document.getElementById('fDateStart').addEventListener('change', function() {
  const end = document.getElementById('fDateEnd');
  if (!end.value||end.value<this.value) end.value = this.value;
});

/* Checkbox toggle with color feedback */
function syncCheckUI(inputId, rowId, boxId) {
  const checked = document.getElementById(inputId).checked;
  document.getElementById(rowId).classList.toggle('checked', checked);
  document.getElementById(boxId).textContent = checked ? '✓' : '';
}
function toggleCheck(inputId, rowId, boxId) {
  const cb = document.getElementById(inputId);
  cb.checked = !cb.checked;
  syncCheckUI(inputId, rowId, boxId);
}
document.getElementById('remindRow').addEventListener('click', () => toggleCheck('fRemind','remindRow','remindBox'));
document.getElementById('priorityRow').addEventListener('click', () => toggleCheck('fPriority','priorityRow','priorityBox'));

function resetCheckUI() {
  ['fRemind','fPriority'].forEach(id => {
    document.getElementById(id).checked = false;
  });
  syncCheckUI('fRemind','remindRow','remindBox');
  syncCheckUI('fPriority','priorityRow','priorityBox');
}
function setCheckUI(remindVal, priorityVal) {
  document.getElementById('fRemind').checked = !!remindVal;
  document.getElementById('fPriority').checked = !!priorityVal;
  syncCheckUI('fRemind','remindRow','remindBox');
  syncCheckUI('fPriority','priorityRow','priorityBox');
}

render();
// checkTodayReminders は Firebase onSnapshot 初回ロード時に呼ばれる
</script>
</body>
</html>
